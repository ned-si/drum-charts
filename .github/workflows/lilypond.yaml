name: Compile Drum Charts

on:
  push:
    branches: [ main ]
    paths:
      - 'ly/**'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Important: Required to detect changes between commits properly

      - name: Ensure output directory
        run: mkdir -p pdf

      - name: Detect changed LilyPond files
        id: changed_ly
        run: |
          # Diff against the previous commit to find changed .ly files
          CHANGED="$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} -- 'ly/*.ly' | xargs)"
          
          # Count them
          if [ -z "$CHANGED" ]; then
            COUNT=0
          else
            COUNT=$(echo "$CHANGED" | wc -w | tr -d ' ')
          fi
          
          echo "Files detected: $CHANGED"
          echo "files=$CHANGED" >> "$GITHUB_OUTPUT"
          echo "count=$COUNT" >> "$GITHUB_OUTPUT"

      - name: Compile LilyPond files
        if: ${{ steps.changed_ly.outputs.count != '0' }}
        run: |
          # 1. Get the list of changed files
          FILES="${{ steps.changed_ly.outputs.files }}"
          
          # 2. Prepend '/app/' to each file to make the path absolute inside Docker
          #    (e.g., 'ly/song.ly' becomes '/app/ly/song.ly')
          ABS_FILES=""
          for f in $FILES; do
            ABS_FILES="$ABS_FILES /app/$f"
          done

          echo "Compiling: $ABS_FILES"

          # 3. Run Docker with the absolute paths
          docker run --rm -v ${{ github.workspace }}:/app -w /app jeandeaual/lilypond \
          lilypond -o pdf/ $ABS_FILES

      - name: Commit and push PDFs
        uses: stefanzweifel/git-auto-commit-action@v5
        if: ${{ steps.changed_ly.outputs.count != '0' }}
        with:
          commit_message: "chore(pdf): auto-generate PDFs from .ly changes"
          file_pattern: 'pdf/*.pdf'