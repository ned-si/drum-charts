name: Compile Drum Charts

on:
  push:
    branches: [ main ]
    paths:
      - 'ly/**'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Ensure output directory
        run: mkdir -p pdf

      - name: Detect changed LilyPond files
        id: changed_ly
        run: |
          CHANGED="$(git diff --name-only "${{ github.event.before }}" "${{ github.sha }}" -- 'ly/*.ly' | xargs)"
          COUNT=$(printf "%s" "$CHANGED" | wc -w | tr -d ' ')
          echo "files=$CHANGED" >> "$GITHUB_OUTPUT"
          echo "count=$COUNT" >> "$GITHUB_OUTPUT"

      - name: Compile LilyPond files
        uses: jeandeaual/lilypond-action@v2
        if: ${{ steps.changed_ly.outputs.count != '0' }}
        with:
          lilypond-version: stable
          # Compile only changed .ly files to /pdf
          args: -o pdf/ ${{ steps.changed_ly.outputs.files }}

      - name: Commit and push PDFs
        uses: stefanzweifel/git-auto-commit-action@v5
        if: ${{ steps.changed_ly.outputs.count != '0' }}
        with:
          commit_message: "Auto-generate PDFs from .ly changes"
          file_pattern: 'pdf/*.pdf'